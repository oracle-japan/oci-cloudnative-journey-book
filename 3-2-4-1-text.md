# 3-2-4-1. OCI Resource Manager による IaC

#### 1.OCI Cloud Shell 上で本書専用 MuShop の GitHub リポジトリからソースコードを一式をクローン

以下のコマンドを実行して OCI Cloud Shell のホームディレクトリに、本書専用 MuShop のソースコード一式を GitHub リポジトリからクローンします。

```sh
$ git clone https://github.com/oracle-japan/oci-cloudnative.git
Cloning into 'oci-cloudnative'...
remote: Enumerating objects: 22381, done.
remote: Counting objects: 100% (354/354), done.
remote: Compressing objects: 100% (128/128), done.
remote: Total 22381 (delta 308), reused 226 (delta 226), pack-reused 22027 (from 3)
Receiving objects: 100% (22381/22381), 29.71 MiB | 1.73 MiB/s, done.
Resolving deltas: 100% (13832/13832), done.
```
「oci-cloudnative」ディレクトリがあることを確認します。

```sh
$ ls
oci-cloudnative
```

#### 2. OCI Resource Manager のスタック作成時に登録する Terraform のソースコードを「terraform.zip」ファイルとして圧縮

「./oci-cloudnative/deploy/complete」にある「terrafrom」ディレクトを zip ファイルに圧縮します。

```sh
$ cd oci-cloudnative/deploy/complete/
```
```sh
$ zip -r ../../../terraform.zip ./terraform
  adding: terraform/ (stored 0%)
  adding: terraform/.terraform.lock.hcl (deflated 46%)
  adding: terraform/api_gateway.tf (deflated 35%)
・
・
・
```

ホームディレクトリに移動します。

```sh
$ cd
```

「terraform.zip」ファイルがあることを確認します。

```sh
$ ls
oci-cloudnative  terraform.zip
```

### Oracle Autonomous Transaction Processing 情報取得

OCI Cloud Shell のホームディレクトリで以下のコマンドを実行して、「Wallet_mushopdb.zip」がアップロードされていることを確認します。

```sh
$ ls
oci-cloudnative  terraform.zip  Wallet_mushopdb.zip
```

「コピー」したコマンドを OCI Cloud Shell にペーストして、コマンドを実行します。

```sh
$ oci ce cluster create-kubeconfig --cluster-id ocid1.cluster.oc1.ap-tokyo-1.xxxxx --file $HOME/.kube/config --region ap-tokyo-1 --token-version 2.0.0  --kube-endpoint PUBLIC_ENDPOINT
New config written to the Kubeconfig file /home/<your-home-directory-name>/.kube/config
```

Kubernetes クラスタにアクセスできるか以下のコマンドを実行して確認します。3ノードの情報が表示されます。

```sh
$ kubectl get nodes
NAME          STATUS   ROLES   AGE    VERSION
10.0.10.148   Ready    node    6h5m   v1.31.1
10.0.10.171   Ready    node    6h2m   v1.31.1
10.0.10.64    Ready    node    6h5m   v1.31.1
```

MuShop アプリケーションは、mushop Namespace で稼働するため、mushop Namespace を作成します。

```sh
$ kubectl create namespace mushop
namespace/mushop created
```

MuShop アプリケーションが、Oracle Autonomous Transaction Processing に接続するために必要となるAdmin ユーザーのパスワードを持つ「oadb-admin」という名前の Secret を作成します。パスワードは、「oci_Cloud_Native_2025」とします。

```sh
$ kubectl create secret generic oadb-admin --namespace mushop --from-literal=oadb_admin_pw=oci_Cloud_Native_2025
secret/oadb-admin created
```

アップロードした「Wallet_mushopdb.zip」を「Wallet_mushopdb_atp」ディレクトリを作成して、そのディレクトリに解凍します。

```sh
$ mkdir Wallet_mushopdb_atp
```
```sh
$ unzip Wallet_mushopdb.zip -d Wallet_mushopdb_atp
Archive:  Wallet_mushopdb.zip
  inflating: Wallet_mushopdb_atp/ewallet.pem  
  inflating: Wallet_mushopdb_atp/README  
  inflating: Wallet_mushopdb_atp/cwallet.sso  
  inflating: Wallet_mushopdb_atp/tnsnames.ora  
  inflating: Wallet_mushopdb_atp/truststore.jks  
  inflating: Wallet_mushopdb_atp/ojdbc.properties  
  inflating: Wallet_mushopdb_atp/sqlnet.ora  
  inflating: Wallet_mushopdb_atp/ewallet.p12  
  inflating: Wallet_mushopdb_atp/keystore.jks  
```
```sh
$ ls Wallet_mushopdb_atp/
cwallet.sso  ewallet.p12  ewallet.pem  keystore.jks  ojdbc.properties  README  sqlnet.ora  tnsnames.ora  truststore.jks
```

「oadb-wallet」という名前の Secret を作成します。

```sh
$ kubectl create secret generic oadb-wallet --namespace mushop --from-file=Wallet_mushopdb_atp
secret/oadb-wallet created
```

データベース接続に必要となるもう一つの「oadb-connection」という名前 Secret を作成します。「oadb_service」について補足しておきます。oadb_service は MuShop が Oracle Autonomous Database に接続するために使用する「サービス名」を指します。これは Oracle Wallet に含まれる tnsnames.ora ファイルに定義されたエントリの1つであり、ATP接続に使う TNSエイリアス名 のようなものです。

```sh
$ kubectl create secret generic oadb-connection \
  --namespace mushop \
  --from-literal=oadb_wallet_pw=oci_Cloud_Native_2025 \
  --from-literal=oadb_service=mushopdb_tp
secret/oadb-connection created
```

3個の Secret が作成されていることを確認します。

```sh
$ kubectl get secrets -n mushop
NAME              TYPE     DATA   AGE
oadb-admin        Opaque   1      26m
oadb-connection   Opaque   2      84s
oadb-wallet       Opaque   9      17m
```

### OCI Object Storage 情報取得

「oos-bucket」という名前の Secret を作成します。コマンドのオプションに設定する内容は、以下の通りです。

- from-literal=region : ap-tokyo-1（リージョン）
- from-literal=name: mushop
- from-literal=namespace: オブジェクト・ストレージ・ネームスペース
- from-literal=parUrl : コピーした事前認証済リクエストURL

```sh
$ kubectl create secret generic oos-bucket \
  --namespace mushop \
  --from-literal=region=ap-tokyo-1 \
  --from-literal=name=mushop \
  --from-literal=namespace=<your-object-storage-namespace> \
  --from-literal=parUrl=<your-preauthenticated-request-url>
secret/oos-bucket created
```

「oos-bucket」という名前の Secret ができていることを確認します。

```sh
$ kubectl get secrets -n mushop
NAME              TYPE     DATA   AGE
oadb-admin        Opaque   1      84m
oadb-connection   Opaque   2      60m
oadb-wallet       Opaque   9      76m
oos-bucket        Opaque   4      3m29s
```

### OCI Streaming 情報取得

「kafka-secret」という名前の Secret を作成します。コマンドのオプションに設定する内容は、以下の通りです。

- from-literal=server : cell-1.streaming.ap-tokyo-1.oci.oraclecloud.com:9092
- from-literal=config : your-SASL-connection-string

```sh
$ kubectl create secret generic kafka-secret -n mushop --from-literal=server=cell-1.streaming.ap-tokyo-1.oci.oraclecloud.com:9092 --from-literal=config='org.apache.kafka.common.security.plain.PlainLoginModule required username="<your-tenant-name>/<your-mail-adress>/<your-streampool-ocid>" password="<your-authentication-token>";'
secret/kafka-secret created
```

「kafka-secret」という名前の Secret ができていることを確認します。

```sh
$ kubectl get secrets -n mushop
NAME              TYPE     DATA   AGE
kafka-secret      Opaque   2      58s
oadb-admin        Opaque   1      155m
oadb-connection   Opaque   2      130m
oadb-wallet       Opaque   9      146m
oos-bucket        Opaque   4      74m
```

### OCI Cache 情報取得

「cache-endpoint」という名前の Secret を作成します。コマンドのオプションに設定する内容は、以下の通りです。

- from-literal=host : your-primary-endpoint

```sh
$ kubectl create secret generic cache-endpoint --namespace mushop --from-literal=host=<your-primary-endpoint>
secret/cache-endpoint created
```

「cache-endpoint」という名前の Secret ができていることを確認します。

```sh
$ kubectl get secrets -n mushop
NAME              TYPE     DATA   AGE
cache-endpoint    Opaque   1      2m44s
kafka-secret      Opaque   2      37m
oadb-admin        Opaque   1      3h12m
oadb-connection   Opaque   2      167m
oadb-wallet       Opaque   9      3h3m
oos-bucket        Opaque   4      110m
```

### OCI クレデンシャル情報の取得

取得情報（情報の一部をマスクしています）
```sh
[DEFAULT]
user=ocid1.user.oc1..xxxxx
fingerprint=a4:a7:2a:a3:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx
tenancy=ocid1.tenancy.oc1..xxxxx
region=ap-tokyo-1
key_file=<path to your private keyfile> # TODO
```

以下のコマンドを実行して、「private.pem」ファイルがアップロードされていること確認します。

```sh
$ ls
oci-cloudnative  private.pem  terraform.zip  Wallet_mushopdb_atp  Wallet_mushopdb.zip
```

ホームディレクトからファイルのパスを確認します。

```sh
$ pwd
/home/<your-directory>
```

Secret で設定するパスは、以下の通りです。

```sh
/home/<your-directory>/private.pem
```

「oci-credentials」という名前の Secret を作成します。コマンドのオプションに設定する内容は、以下の通りです。

- from-literal=tenancy : ocid1.tenancy.oc1..xxxxx
- from-literal=user : ocid1.user.oc1..xxxxx
- from-literal=region : ap-tokyo-1
- from-literal=fingerprint : a4:a7:2a:a3:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx
- from-file=privatekey : /home/<your-directory>/private.pem

```sh
$ kubectl create secret generic oci-credentials \
  --namespace mushop \
  --from-literal=tenancy=ocid1.tenancy.oc1..xxxxx \
  --from-literal=user=ocid1.user.oc1..xxxxx \
  --from-literal=region=ap-tokyo-1\
  --from-literal=fingerprint=a4:a7:2a:a3:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx \
  --from-file=privatekey=/home/<your-directory>/private.pem
secret/oci-credentials created
```

「oci-credentials」という名前の Secret ができていることを確認します。

```sh
$ kubectl get secrets -n mushop
NAME              TYPE     DATA   AGE
cache-endpoint    Opaque   1      2m44s
kafka-secret      Opaque   2      37m
oadb-admin        Opaque   1      3h12m
oadb-connection   Opaque   2      167m
oadb-wallet       Opaque   9      3h3m
oci-credentials   Opaque   5      46s
oos-bucket        Opaque   4      110m
```

以上で、Secret の作成は完了です。

## OCI Functions のセットアップ

- ステップ2

「fn list context」コマンドを実行します。「CURRENT」が「ap-tokyo-1」となります。

```sh
$ fn list context
CURRENT NAME            PROVIDER        API URL                                                 REGISTRY
*       ap-tokyo-1      oracle-cs       https://functions.ap-tokyo-1.oci.oraclecloud.com        nrt.ocir.io/xxxxxxxx/
        default         oracle-cs
```

既にカレントのリージョンが「ap-tokyo-1」ですが、手順通りに従って「fn use context ap-tokyo-1」コマンドを実行します。

```sh
$ fn use context ap-tokyo-1

Fn: Context ap-tokyo-1 currently in use

See 'fn <command> --help' for more information. Client version: 0.6.38
```

- ステップ3

ファンクションのコンパートメント ID でコンテキストを更新します。

```sh
$ fn update context oracle.compartment-id ocid1.tenancy.oc1..xxxxxxxx
Current context updated oracle.compartment-id with ocid1.tenancy.oc1..xxxxxxxx
```

- ステップ4

OCIR にファンクションイメージを格納するリポジトリを設定します。[repo-name-prefix] の箇所は、mushop-fn として進めます。

```sh
$ fn update context registry nrt.ocir.io/<your-object-storage-namespace>/mushop-fn
Current context updated registry with nrt.ocir.io/<your-object-storage-namespace>/mushop-fn
```

- ステップ5

「認証トークンの生成」は、事前に作成している（本項「事前情報取得」-「パスワード取得」）のでそれを使用します。

- ステップ6

OCIR にログインします。パスワードは、事前に取得した認証トークンを使用します。

```sh
$ docker login -u '<your-object-storage-namespace>/<your-mail-adress>' nrt.ocir.io
Password:
Login Succeeded!
```

コンパートメント内のアプリケーションを一覧表示します。プロビジョニングされている mushop-app が表示されます。

```sh
$ fn list apps
NAME            ID
mushop-app      ocid1.fnapp.oc1.ap-tokyo-1.xxxxxxxx
```

最後に、「閉じる」ボタンをクリックします。

MuShop ニュースレター購読サービスのファンクションをデプロイします。
クローンしたソースコードの「oci-cloudnative/src/functions/newsletter-subscription」ディレクトリに移動して、「fn deploy」コマンドを実行します。

```sh
$ cd oci-cloudnative/src/functions/newsletter-subscription
```

「2-2-2-3. OCI Functions」で説明した通り、OCI Functions は、Fn Project のマネージドサービスです。仕組みとしては、コンテナ技術を使用しています。移動したディレクトリには以下のファイルが格納されています。

```sh
$ ls
Dockerfile  func.js  func.yaml  package.json  README.md
```

「fn deploy」コマンドを実行すると、ビルド処理が実行されて、コンテナイメージが生成されます。そのコンテナイメージがセットアップ時に設定した OCIR のリポジトリにプッシュされます。そして、OCI Functions のアプリケーションにそのイメージがファンクション、つまり関数として登録されます。

```sh
$ fn deploy --app mushop-app
Deploying newsletter-subscription to app: mushop-app
Bumped to version 0.1.1
Using Container engine docker
Building image nrt.ocir.io/<your-object-storage-namespace>/mushop-fn/newsletter-subscription:0.1.1 TargetedPlatform:  amd64HostPlatform:  amd64
................................................................
Using Container engine  docker  to push
Pushing nrt.ocir.io/<your-object-storage-namespace>/mushop-fn/newsletter-subscription:0.1.1 to docker registry...Getting image source signatures
Copying blob bee2b9567351 done   | 
Copying blob bd0aa95729bc done   | 
Copying blob dbddb273e6cf done   | 
Copying blob 2521451d9dc0 done   | 
Copying config 5ea0d66286 done   | 
Writing manifest to image destination
Updating function newsletter-subscription using image nrt.ocir.io/<your-object-storage-namespace>/mushop-fn/newsletter-subscription:0.1.1...
Successfully created function: newsletter-subscription with nrt.ocir.io/<your-object-storage-namespace>/mushop-fn/newsletter-subscription:0.1.1
```

ここからは、事前に取得した資格証明の「ユーザー名」と「パスワード」を「newsletter-subscription」ファンクションに設定します。

「ユーザー名」設定
```sh
$ fn config function mushop-app newsletter-subscription SMTP_USER "ocid1.user.oc1..xxxxxxxx@ocid1.tenancy.oc1..xxxxxxxx.mi.com"
mushop-app newsletter-subscription updated SMTP_USER with ocid1.user.oc1..xxxxxxxx@ocid1.tenancy.oc1..xxxxxxxx.mi.com
```
「パスワード」設定
```sh
$ fn config function mushop-app newsletter-subscription SMTP_PASSWORD '<your-authentication-token>'
mushop-app newsletter-subscription updated SMTP_PASSWORD with <your-authentication-token>
```

「パブリック・エンドポイント」設定
```sh
$ fn config function mushop-app newsletter-subscription SMTP_HOST "smtp.email.ap-tokyo-1.oci.oraclecloud.com"
mushop-app newsletter-subscription updated SMTP_HOST with smtp.email.ap-tokyo-1.oci.oraclecloud.com
```
「SMTPポート」設定
```sh
$ fn config function mushop-app newsletter-subscription SMTP_PORT "587"
mushop-app newsletter-subscription updated SMTP_PORT with 587
```
「承認済送信者メールアドレス」設定
```sh
$ fn config function mushop-app newsletter-subscription APPROVED_SENDER_EMAIL "<your-mail-address>"
mushop-app newsletter-subscription updated APPROVED_SENDER_EMAIL with <your-mail-address>
```