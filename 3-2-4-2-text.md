# 3-2-4-2. OCI DevOps による CI/CD

## OCI Vault から OCI Registry ログイン情報を参照する設定

OCI Cloud Shell を使用します。ホームディレクトリに移動します。（既にホームディレクトリの場合は不要です）

```sh
$ cd
```

ホームディレクトリにある「oci-cloudnative」ディレクトリの「build_spec.yaml」を vim コマンドで開いて、「OCI_REGISTRY_USERNAME_OCID」と「OCI_REGISTRY_PASSWORD_OCID」を事前に OCI Vault で取得した OCID に変更して保存します。

```sh
$ vim oci-cloudnative/build_spec.yaml
```

```sh
version: 0.1
component: build
timeoutInSeconds: 10000
runAs: root
shell: bash
env:
# OCI Vault Use
  vaultVariables:
    OCI_REGISTRY_USERNAME: "OCI_REGISTRY_USERNAME_OCID"
    OCI_REGISTRY_PASSWORD: "OCI_REGISTRY_PASSWORD_OCID"
# OCI Vault Not Use
# variables:
#    OCI_REGISTRY_USERNAME: "your-object-storage-namespace/your-mail-address"
#    OCI_REGISTRY_PASSWORD: "your-authentication-token"
  exportedVariables:
    - VERSION
・
・＜省略＞
・
```

参考例
```sh
version: 0.1
component: build
timeoutInSeconds: 10000
runAs: root
shell: bash
env:
# OCI Vault Use
  vaultVariables:
    OCI_REGISTRY_USERNAME: "ocid1.vaultsecret.oc1.ap-tokyo-1.xxxxxxxxxx"
    OCI_REGISTRY_PASSWORD: "ocid1.vaultsecret.oc1.ap-tokyo-1.xxxxxxxxxx"
# OCI Vault Not Use
# variables:
#    OCI_REGISTRY_USERNAME: "your-object-storage-namespace/your-mail-address"
#    OCI_REGISTRY_PASSWORD: "your-authentication-token"
  exportedVariables:
    - VERSION
・
・＜省略＞
・
```

以上で、OCI Vault から OCI Registry のログイン情報を参照する設定は完了です。  

## 2.「build_spec.yaml」の編集

「build_spec.yaml」を以下のように変更して利用します。本書「3-2-4-1. OCI Resource Manager による IaC」の「OCI Resource Manager によるプロビジョニング」
で取得した「ユーザー名」と「パスワード」を「OCI_REGISTRY_USERNAME」と「OCI_REGISTRY_PASSWORD」に定義します。

```sh
$ vim oci-cloudnative/build_spec.yaml
```

```sh
version: 0.1
component: build
timeoutInSeconds: 10000
runAs: root
shell: bash
env:
# OCI Vault Use
# vaultVariables:
#   OCI_REGISTRY_USERNAME: "OCI_REGISTRY_USERNAME_OCID"
#   OCI_REGISTRY_PASSWORD: "OCI_REGISTRY_PASSWORD_OCID"
# OCI Vault Not Use
  variables:
     OCI_REGISTRY_USERNAME: "<your-object-storage-namespace>/<your-mail-address>"
     OCI_REGISTRY_PASSWORD: "<your-authentication-token>"
  exportedVariables:
    - VERSION
・
・＜省略＞
・
```

ホームディレクトリに移動します。（既にホームディレクトリの場合は不要です）

```sh
$ cd
```

```sh
$ git clone https://devops.scmservice.ap-tokyo-1.oci.oraclecloud.com/namespaces/<your-object-storage-namespace>/projects/mushop/repositories/mushop-devops
Cloning into 'mushop-devops'...
Username for 'https://devops.scmservice.ap-tokyo-1.oci.oraclecloud.com': <your-tenacny-name>/<your-mailadress>
Password for 'https://<your-tenacny-name>/<your-mailadress>@devops.scmservice.ap-tokyo-1.oci.oraclecloud.com': 
remote: Counting objects: 2, done
remote: Finding sources: 100% (2/2)
remote: Getting sizes: 100% (1/1)
remote: Total 2 (delta 0), reused 2 (delta 0)
Unpacking objects: 100% (2/2), 141 bytes | 47.00 KiB/s, done.
```

「mushop-devops」ディレクトリがあることを確認します。

```sh
$ ls
mushop-devops  oci-cloudnative  private.pem  terraform.zip  Wallet_mushopdb_atp  Wallet_mushopdb.zip
```

以下のコマンドを実行して、本書専用 MuShop のソースコード一式を「mushop-devops」ディレクトリにコピーします。

```sh
$ cp -R oci-cloudnative/* ./mushop-devops
```

コピーできていることを確認します。

```sh
$ ls mushop-devops
appVersion  build_spec.yaml  ci  CONTRIBUTING.md  deploy  images  LICENSE  README.md  src  THIRDPARTY.md
```

OCI DevOps の「mushop-devops」リポジトリにコミットして、プッシュします。

```sh
$ cd mushop-devops
```
```sh
$ git add -A .
```

メールアドレスとユーザー名は任意で問題ありません。

```sh
$ git config --global user.email "you@example.com"
```
```sh
$ git config --global user.name "Your Name"
```

```sh
$ git commit -m "first commit"
[main 7fb89b4] first commit
 526 files changed, 85035 insertions(+)
 create mode 100644 CONTRIBUTING.md
 create mode 100644 LICENSE
 create mode 100644 README.md
・
・＜省略＞
・
```

main ブランチを指定します。

```sh
$ git branch -M main
```

ユーザー名とパスワードは、git clone した時と同じものを入力します。

```sh
$ git push -u origin main
Username for 'https://devops.scmservice.ap-tokyo-1.oci.oraclecloud.com': <your-tenacny-name>/<your-mailadress>
Password for 'https://<your-tenacny-name>/<your-mailadress>@devops.scmservice.ap-tokyo-1.oci.oraclecloud.com': 
Enumerating objects: 657, done.
Counting objects: 100% (657/657), done.
Delta compression using up to 2 threads
Compressing objects: 100% (585/585), done.
Writing objects: 100% (656/656), 7.68 MiB | 8.27 MiB/s, done.
Total 656 (delta 95), reused 0 (delta 0), pack-reused 0
remote: Resolving deltas: 100% (95/95)
remote: 
remote: Create Pull Request for branch main:
remote:  https://cloud.oracle.com/devops-coderepository/repositories/ocid1.devopsrepository.oc1.ap-tokyo-1.xxxxxx/pull-requests?open=create-pull-request&branchName=main&region=ap-tokyo-1
remote: 
To https://devops.scmservice.ap-tokyo-1.oci.oraclecloud.com/namespaces/<your-object-storage-namespace>/projects/mushop/repositories/mushop-devops
   6e4d077..7fb89b4  main -> main
branch 'main' set up to track 'origin/main'.
```

OCI Cloud Shell で以下のコマンドを実行して、デプロイされていることを確認します。

```sh
$ kubectl get pods -n mushop
NAME                                 READY   STATUS    RESTARTS   AGE
mushop-api-5798bd9857-zj4hf          1/1     Running   0          67m
mushop-assets-54fcbbf8c8-tl66k       1/1     Running   0          67m
mushop-carts-5bd5f4f5f9-w8glp        1/1     Running   0          67m
mushop-catalogue-7bc94759f8-d2jx4    1/1     Running   0          67m
mushop-edge-59b6cd94cc-vfmlq         1/1     Running   0          67m
mushop-fulfillment-9b8f49d4b-9qkrw   1/1     Running   0          67m
mushop-orders-7d4dc78bd-kn6v6        1/1     Running   0          67m
mushop-payment-74787559f8-mvjgz      1/1     Running   0          67m
mushop-storefront-5899b68699-ttjff   1/1     Running   0          67m
mushop-user-6b8cfcdcbf-8qfg5         1/1     Running   0          67m
```

以下のコマンドを実行して、「mushop-utilities-ingress-nginx-controller」の「EXTERNAL-IP」を確認します。この EXTERNAL-IP にブラウザでアクセスすると MuShop のトップページが表示されます。

```sh
$ kubectl get services -n mushop-utilities
NAME                                                  TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)                      AGE
mushop-utilities-ingress-nginx-controller             LoadBalancer   10.96.74.75    xxx.xxx.xxx.xxx   80:30685/TCP,443:30175/TCP   69m
mushop-utilities-ingress-nginx-controller-admission   ClusterIP      10.96.92.6     <none>           443/TCP                      69m
mushop-utilities-ingress-nginx-controller-metrics     ClusterIP      10.96.83.123   <none>           10254/TCP                    69m
mushop-utilities-metrics-server                       ClusterIP      10.96.242.76   <none>           443/TCP                      69m
```

以上で、OCI DevOps を利用した CI/CD は完了となります。